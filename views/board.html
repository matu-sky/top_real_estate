<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= board.name %> | 탑 부동산</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/header.html') %>

    <main class="board-container">
        <%
            let headerStyle, titleStyle, descriptionStyle, subNavStyle = '';
            subNavStyle = 'margin-bottom: 0;';

            if (board.board_type === 'youtube') {
                // 유튜브 게시판: 상단 여백 제거 및 특정 스타일 적용
                headerStyle = `
                    background-image: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), url('https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=2071&auto=format&fit=crop');
                    background-size: cover;
                    background-position: center;
                    padding: 4rem 2rem;
                    text-align: center;
                    margin-bottom: 2rem;
                `;
                titleStyle = `color: #111111; text-shadow: none;`;
                descriptionStyle = `color: #333333; text-shadow: none;`;
            } else {
                // 다른 모든 게시판: 기존 스타일
                headerStyle = `
                    background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=2070&auto=format&fit=crop');
                    background-size: cover;
                    background-position: center;
                    padding: 4rem 2rem;
                    text-align: center;
                    margin-bottom: 2rem;
                `;
                titleStyle = `color: #ffffff; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);`;
                descriptionStyle = `color: #eeeeee; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);`;
            }
        %>
        <div class="sub-nav" style="<%- subNavStyle %>">
            <a href="/board/notice" class="sub-nav-item notice-link <%= board.slug === 'notice' ? 'active' : '' %>">공지사항</a>
            <a href="/board/rearinfo" class="sub-nav-item rearinfo-link <%= board.slug === 'rearinfo' ? 'active' : '' %>">부동산정보</a>
            <a href="/board/realcun" class="sub-nav-item realcun-link <%= board.slug === 'realcun' ? 'active' : '' %>">부동산관련상담</a>
            <a href="/board/utube" class="sub-nav-item utube-link <%= board.slug === 'utube' ? 'active' : '' %>">동영상 갤러리</a>
        </div>

        <div class="board-header" style="<%- headerStyle %>">
            <h1 style="<%- titleStyle %>">
                <%= board.name %>
            </h1>
            <p style="<%- descriptionStyle %>">
                <%= board.description %>
            </p>
        </div>

        <div class="container">
            <div class="board-toolbar">
            <% if (user && user.loggedin) { %>
                <a href="/board/<%= board.slug %>/write" class="btn btn-primary">글쓰기</a>
            <% } %>
            </div>

            <div class="post-list">
            <% if (board.board_type === 'archive') { %>
                <%
                    const formatBytes = (bytes, decimals = 2) => {
                        if (!bytes || bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const dm = decimals < 0 ? 0 : decimals;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                    }

                    const getFileIcon = (fileName) => {
                        if (!fileName) return 'fa-file-o';
                        const ext = fileName.split('.').pop().toLowerCase();
                        switch (ext) {
                            case 'pdf': return 'fa-file-pdf-o';
                            case 'doc':
                            case 'docx': return 'fa-file-word-o';
                            case 'xls':
                            case 'xlsx': return 'fa-file-excel-o';
                            case 'ppt':
                            case 'pptx': return 'fa-file-powerpoint-o';
                            case 'zip':
                            case 'rar':
                            case '7z': return 'fa-file-archive-o';
                            case 'jpg':
                            case 'jpeg':
                            case 'png':
                            case 'gif': return 'fa-file-image-o';
                            case 'mp4':
                            case 'mov':
                            case 'avi': return 'fa-file-video-o';
                            case 'txt': return 'fa-file-text-o';
                            default: return 'fa-file-o';
                        }
                    }
                %>
                <link rel="stylesheet" href="/css/archive_board.css">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

                <h2 class="archive-header">다운로드 자료실</h2>

                <table class="archive-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 50%; text-align: left;">제목</th>
                            <th style="width: 15%; text-align: center;">파일크기</th>
                            <th style="width: 15%; text-align: center;">작성일</th>
                            <% if (user && user.loggedin) { %>
                                <th style="width: 15%; text-align: center;">관리</th>
                            <% } %>
                        </tr>
                    </thead>
                    <tbody>
                        <% posts.forEach((post, index) => { %>
                            <%
                                let fileMeta = null;
                                if (post.attachment_path) {
                                    try { fileMeta = JSON.parse(post.attachment_path); } catch (e) { fileMeta = null; }
                                }
                            %>
                            <tr>
                                <td style="text-align: center;"><%= posts.length - index %></td>
                                <td class="post-title">
                                    <% if (fileMeta && fileMeta.url) { %>
                                        <a href="/download/<%= post.id %>" title="<%= fileMeta.name %>">
                                            <i class="fa <%= getFileIcon(fileMeta.name) %> file-icon"></i>
                                            <%= post.title %>
                                        </a>
                                    <% } else { %>
                                        <a href="/board/<%= board.slug %>/<%= post.id %>">
                                            <i class="fa fa-file-o file-icon"></i>
                                            <%= post.title %>
                                        </a>
                                    <% } %>
                                </td>
                                <td class="file-size" style="text-align: center;"><%= fileMeta ? formatBytes(fileMeta.size) : '-' %></td>
                                <td class="post-date" style="text-align: center;"><%= new Date(post.created_at).toLocaleDateString('ko-KR') %></td>
                                <% if (user && user.loggedin) { %>
                                    <td style="text-align: center;">
                                        <a href="/board/<%= board.slug %>/<%= post.id %>/edit" class="btn btn-sm-secondary" style="margin-right: 5px;">수정</a>
                                        <form action="/board/<%= board.slug %>/<%= post.id %>/delete" method="POST" style="display: inline-block;">
                                            <button type="submit" class="btn btn-sm-danger" onclick="return confirm('정말로 이 글을 삭제하시겠습니까?');">삭제</button>
                                        </form>
                                    </td>
                                <% } %>
                            </tr>
                        <% }); %>
                        <% if (posts.length === 0) { %>
                            <tr>
                                <td colspan="<%= (user && user.loggedin) ? 5 : 4 %>" style="text-align: center; padding: 20px;">아직 등록된 글이 없습니다.</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            <% } else { %>
                <% posts.forEach(post => { %>
                <%
                    let thumbnailUrl = post.thumbnail_url; // 1. DB에 저장된 썸네일 우선 사용
                    let isDirectVideo = false;

                    // 2. DB 썸네일이 없을 경우, 첨부파일 경로를 확인
                    if (!thumbnailUrl && post.attachment_path) {
                        const isVideoFile = (path) => ['.mp4', '.webm', '.ogg'].some(ext => path.toLowerCase().endsWith(ext));

                        if (board.board_type === 'gallery') {
                            try {
                                const images = JSON.parse(post.attachment_path);
                                if (Array.isArray(images) && images.length > 0) thumbnailUrl = images[0];
                            } catch (e) { thumbnailUrl = post.attachment_path; }
                        } else if (board.board_type === 'news') {
                            thumbnailUrl = post.attachment_path;
                        } else if (isVideoFile(post.attachment_path)) {
                            isDirectVideo = true;
                                                                                                                thumbnailUrl = '/images/video-placeholder-icon.svg'; // 직접 업로드 동영상용 기본 아이콘
                        } else {
                            // 첨부파일이 이미지일 경우
                            thumbnailUrl = post.attachment_path;
                        }
                    }
                %>
                <div class="post-card">
                    <div class="post-card-content" <% if (thumbnailUrl) { %>style="display: flex; align-items: flex-start; gap: 1rem;"<% } %>>
                        <%# 썸네일 (공통 로직) %>
                        <% if (thumbnailUrl) { %>
                            <div class="post-card-thumbnail" style="flex-shrink: 0;">
                                <a href="/board/<%= board.slug %>/<%= post.id %>">
                                    <img src="<%= thumbnailUrl %>" alt="<%= post.title %> 썸네일" style="width: 120px; height: 90px; object-fit: cover; display: block; <% if(isDirectVideo) { %> background-color: #f0f0f0; padding: 10px; <% } %>">
                                </a>
                            </div>
                        <% } %>

                        <%# 텍스트 컨텐츠 %>
                        <div class="post-text-content" style="flex-grow: 1;">
                            <h3><a href="/board/<%= board.slug %>/<%= post.id %>"><%= post.title %></a></h3>
                            <p class="post-card-snippet">
                                    <% if (post.content) { 
                                        const strippedContent = post.content.replace(/<[^>]*>?/gm, '');
                                    %>
                                        <%- strippedContent.substring(0, 100) %><% if (strippedContent.length > 100) { %>...<% } %>
                                    <% } %>
                                </p>
                            <div class="post-card-meta">
                                <span><strong>작성자:</strong> <%= post.author %></span>
                                <span><strong>작성일:</strong> <%= new Date(post.created_at).toLocaleDateString('ko-KR') %></span>
                            </div>
                        </div>
                    </div>
                    <% if (user && user.loggedin) { %>
                        <div class="post-card-actions">
                            <a href="/board/<%= board.slug %>/<%= post.id %>/edit" class="btn btn-sm-secondary">수정</a>
                            <form action="/board/<%= board.slug %>/<%= post.id %>/delete" method="POST" style="display: inline-block;">
                                <button type="submit" class="btn btn-sm-danger" onclick="return confirm('정말로 이 글을 삭제하시겠습니까?');">삭제</button>
                            </form>
                        </div>
                    <% } %>
                </div>
            <% }); %>

            <% if (posts.length === 0) { %>
                <div class="post-card">
                    <p>아직 등록된 글이 없습니다. 첫 번째 글을 작성해보세요!</p>
                </div>
            <% } %>
            <% } %>
            </div>
    </main>

    <%- include('partials/footer.html') %>
    <script src="/js/main.js"></script>
</body>
</html>