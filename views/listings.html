<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매물 관리 | 관리자</title>
    <link rel="stylesheet" href="/css/admin_style.css">
    <link rel="stylesheet" href="/css/add_property_form.css">
    <style>
        .modal {
            display: none; 
            position: fixed; 
            z-index: 9999; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1000px;
            border-radius: 8px;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .filter-bar {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        .filter-btn {
            text-decoration: none;
            color: #495057;
            padding: 8px 12px;
            margin-right: 10px;
            border-radius: 5px;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-btn:hover {
            background-color: #e9ecef;
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <%- include('partials/admin_sidebar.html') %>

        <main class="main-content">
            <header class="content-header">
                <h2>매물 관리</h2>
                <div class="header-actions">
                    <a href="/add_property" class="btn">주거용 매물 등록</a>
                    <a href="/add_commercial_property" class="btn">상업용 매물 등록</a>
                    <a href="/add_factory_property" class="btn">공장/지산 등록</a>
                    <a href="#" class="btn">기타 매물</a>
                </div>
            </header>

            <div class="card">
                <div class="card-header filter-bar">
                    <a href="/listings" class="filter-btn <%= !currentCategory ? 'active' : '' %>">전체</a>
                    <a href="/listings?category=주거용" class="filter-btn <%= currentCategory === '주거용' ? 'active' : '' %>">주거용</a>
                    <a href="/listings?category=상업용" class="filter-btn <%= currentCategory === '상업용' ? 'active' : '' %>">상업용</a>
                    <a href="/listings?category=공장/지산" class="filter-btn <%= currentCategory === '공장/지산' ? 'active' : '' %>">공장/지산</a>
                </div>
                <div class="card-body">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>제목</th>
                                <th>카테고리</th>
                                <th>주소</th>
                                <th>가격</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% properties.forEach(property => { %>
                                <tr data-id="<%= property.id %>">
                                    <td><%= property.id %></td>
                                    <td><%= property.title %></td>
                                    <td><%= property.category %></td>
                                    <td><%= property.address %></td>
                                    <td><%= property.price %></td>
                                    <td>
                                        <button class="btn-edit">수정</button>
                                        <form action="/listings/delete/<%= property.id %>" method="POST" style="display: inline;" onsubmit="return confirm('정말로 이 매물을 삭제하시겠습니까?');">
                                            <button type="submit" class="btn-delete">삭제</button>
                                        </form>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- 수정 모달 -->
    <div id="form-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="deleted_image_paths_container"></div>
                    <h4 id="modal-title" style="margin-top:0; margin-bottom: 20px; font-size: 1.5rem;">매물 수정</h4>
            <form id="modal-form" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="existing_image_paths" name="existing_image_paths">
                
                <div class="card">
                    <div class="card-header"><h4>기본 정보</h4></div>
                    <div class="card-body form-grid">
                        <div class="form-group"><label for="title">제목</label><input type="text" id="title" name="title" required></div>
                        <div class="form-group"><label for="price">가격</label><input type="text" id="price" name="price"></div>
                        <div class="form-group"><label for="category">매물 구분</label><select id="category" name="category" required><option value="주거용">주거용</option><option value="상업용">상업용</option><option value="공장/지산">공장/지산</option></select></div>
                        <div class="form-group"><label for="area">평수</label><input type="number" id="area" name="area"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h4>상세 정보</h4></div>
                    <div class="card-body form-grid">
                        <div class="form-group"><label for="address">소재지</label><input type="text" id="address" name="address"></div>
                        <div class="form-group"><label for="exclusive_area">면적(m²)</label><input type="number" id="exclusive_area" name="exclusive_area" step="0.01"></div>
                        <div class="form-group"><label for="approval_date">사용승인일</label><input type="date" id="approval_date" name="approval_date"></div>
                        <div class="form-group"><label for="purpose">물건의 용도</label><input type="text" id="purpose" name="purpose"></div>
                        <div class="form-group"><label for="total_floors">총층</label><input type="number" id="total_floors" name="total_floors"></div>
                        <div class="form-group"><label for="floor">해당층</label><input type="number" id="floor" name="floor"></div>
                        <div class="form-group"><label for="direction">방향</label><input type="text" id="direction" name="direction"></div>
                        <div class="form-group"><label for="direction_standard">향 기준</label><input type="text" id="direction_standard" name="direction_standard"></div>
                        <div class="form-group"><label for="transaction_type">거래 형태</label><input type="text" id="transaction_type" name="transaction_type"></div>
                        <div class="form-group"><label for="parking">주차대수</label><input type="number" id="parking" name="parking"></div>
                        <div class="form-group"><label for="maintenance_fee">관리비</label><input type="number" id="maintenance_fee" name="maintenance_fee"></div>
                        <div class="form-group"><label for="move_in_date">입주가능일</label><input type="date" id="move_in_date" name="move_in_date"></div>
                        <div class="form-group full-width"><label for="description">물건 설명</label><textarea id="description" name="description" rows="6"></textarea></div>
                        <div class="form-group full-width"><label for="youtube_url">YouTube URL</label><input type="text" id="youtube_url" name="youtube_url"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h4>이미지 관리</h4></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>현재 이미지</label>
                            <div id="current-images" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; min-height: 50px;"></div>
                        </div>
                        <div class="form-group">
                            <label for="images">새 이미지 추가</label>
                            <input type="file" id="images" name="images" multiple>
                            <div id="new-image-preview-container"></div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn save">수정사항 저장</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('form-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalForm = document.getElementById('modal-form');
        const closeBtn = document.querySelector('.close-btn');
        const newImageInput = modalForm.querySelector('#images');
        const newImagePreviewContainer = modalForm.querySelector('#new-image-preview-container');
        let newSelectedFiles = [];

        newImageInput.addEventListener('change', () => {
            Array.from(newImageInput.files).forEach(file => newSelectedFiles.push(file));
            updateNewImagePreview();
        });

        function updateNewImagePreview() {
            newImagePreviewContainer.innerHTML = '';
            newSelectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    previewItem.appendChild(img);
                    const fileName = document.createElement('span');
                    fileName.textContent = file.name;
                    previewItem.appendChild(fileName);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'X';
                    deleteBtn.className = 'delete-preview-btn';
                    deleteBtn.type = 'button';
                    deleteBtn.onclick = () => {
                        newSelectedFiles.splice(index, 1);
                        updateNewImagePreview();
                    };
                    previewItem.appendChild(deleteBtn);
                    newImagePreviewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }

        // 모달이 열릴 때마다 파일 목록 초기화
        function resetImageUploadState() {
            newSelectedFiles = [];
            newImageInput.value = ''; // 파일 선택 창 비우기
            updateNewImagePreview();
        }

        document.querySelectorAll('.btn-edit').forEach(button => {
            button.addEventListener('click', async (e) => {
                const row = e.target.closest('tr');
                const propertyId = row.dataset.id;

                try {
                    const response = await fetch(`/api/property/${propertyId}`);
                    if (!response.ok) throw new Error('매물 정보를 불러오는 데 실패했습니다.');
                    
                    const property = await response.json();

                    resetImageUploadState(); // 이미지 업로드 상태 초기화

                    modalTitle.innerText = '매물 수정';
                    modalForm.action = `/listings/edit/${property.id}`;
                    modalForm.reset();

                    for (const key in property) {
                        if (modalForm.elements[key]) {
                            modalForm.elements[key].value = property[key] || '';
                        }
                    }

                    const existingImagesField = document.getElementById('existing_image_paths');
                    const currentImagesContainer = document.getElementById('current-images');
                    
                    existingImagesField.value = property.image_path || '';
                    currentImagesContainer.innerHTML = '';

                    if (property.image_path) {
                        const imagePaths = property.image_path.split(',').filter(p => p);
                        imagePaths.forEach(path => {
                            const imgContainer = document.createElement('div');
                            imgContainer.style.position = 'relative';
                            imgContainer.style.marginRight = '10px';

                            const imgElement = document.createElement('img');
                            imgElement.src = path;
                            imgElement.style.width = '100px';
                            imgElement.style.height = 'auto';
                            imgContainer.appendChild(imgElement);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.innerText = 'X';
                            deleteBtn.type = 'button'; // 중요: 폼 제출 방지
                            deleteBtn.style.position = 'absolute';
                            deleteBtn.style.top = '0';
                            deleteBtn.style.right = '0';
                            deleteBtn.style.background = 'red';
                            deleteBtn.style.color = 'white';
                            deleteBtn.style.border = 'none';
                            deleteBtn.style.cursor = 'pointer';

                            deleteBtn.onclick = () => {
                                // 숨겨진 필드에 삭제할 이미지 경로 추가
                                const deletedInput = document.createElement('input');
                                deletedInput.type = 'hidden';
                                deletedInput.name = 'deleted_images';
                                deletedInput.value = path;
                                document.getElementById('deleted_image_paths_container').appendChild(deletedInput);

                                // 화면에서 이미지 컨테이너 제거
                                imgContainer.remove();

                                // 기존 이미지 목록에서 해당 경로 제거
                                const existingImagesField = document.getElementById('existing_image_paths');
                                const updatedPaths = existingImagesField.value.split(',').filter(p => p !== path);
                                existingImagesField.value = updatedPaths.join(',');
                            };

                            imgContainer.appendChild(deleteBtn);
                            currentImagesContainer.appendChild(imgContainer);
                        });
                    } else {
                        currentImagesContainer.innerText = '업로드된 이미지가 없습니다.';
                    }

                    modal.style.display = 'block';

                } catch (error) {
                    console.error('수정 과정에서 오류 발생:', error);
                    alert(error.message);
                }
            });
        });

        closeBtn.onclick = () => { modal.style.display = 'none'; }
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>

</body>
</html>