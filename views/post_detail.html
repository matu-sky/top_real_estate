<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= post.title %> | <%= board.name %></title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/header.html') %>

    <main class="container">
        <section class="post-detail">
            <h2><%= post.title %></h2>
            <div class="post-meta">
                <span>작성자: <%= post.author %></span>
                <span>작성일: <%= new Date(post.created_at).toLocaleDateString('ko-KR') %></span>
            </div>

            <div class="post-content">
                <%# 유튜브 게시판 %>
                <% if (board.board_type === 'youtube' && post.youtube_url) { %>
                    <div class="youtube-video-container">
                        <% 
                            const videoId = post.youtube_url.includes('v=') ? post.youtube_url.split('v=')[1].split('&')[0] : post.youtube_url.split('/').pop();
                        %>
                        <iframe src="https://www.youtube.com/embed/<%= videoId %>" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                <% } %>

                <%# 갤러리 게시판 %>
                <% if (board.board_type === 'gallery' && post.attachment_path) { %>
                    <div class="gallery-container">
                        <% 
                            try {
                                const images = JSON.parse(post.attachment_path);
                                if (Array.isArray(images)) {
                                    images.forEach(image_url => { %>
                                        <img src="<%= image_url %>" alt="갤러리 이미지" class="gallery-image">
                                    <% });
                                }
                            } catch (e) { /* 파싱 오류 무시 */ } %>
                    </div>
                <% } %>

                <%# 일반/뉴스 게시판의 첨부파일 %>
                <% if ((board.board_type === 'general' || board.board_type === 'news') && post.attachment_path) { %>
                    <div class="post-attachment">
                        <% 
                            const fileNameWithTimestamp = post.attachment_path.split('/').pop();
                            const base64Part = fileNameWithTimestamp.substring(fileNameWithTimestamp.indexOf('_') + 1);
                            const decodedFileName = Buffer.from(base64Part, 'base64').toString('utf8');
                        %>
                        <strong>첨부파일:</strong>
                        <a href="<%= post.attachment_path %>" target="_blank" download="<%= decodedFileName %>">
                            <%= decodedFileName %>
                        </a>
                    </div>
                <% } %>

                <div class="post-body">
                    <p><%- post.content.replace(/\n/g, '<br>') %></p>
                </div>
            </div>

            <div class="post-actions">
                <a href="/board/<%= board.slug %>" class="btn-secondary">목록으로</a>
                <% if (user && user.loggedin) { %>
                    <a href="/board/<%= board.slug %>/<%= post.id %>/edit" class="btn-primary">수정</a>
                    <form action="/board/<%= board.slug %>/<%= post.id %>/delete" method="POST" style="display: inline;">
                        <button type="submit" class="btn-danger" onclick="return confirm('정말로 이 글을 삭제하시겠습니까?');">삭제</button>
                    </form>
                <% } %>
            </div>
        </section>
    </main>

    <%- include('partials/footer.html') %>
</body>
</html>